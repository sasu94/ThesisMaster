<!DOCTYPE>
<html>
<head>
  <meta charset="utf-8"/>
  <title>
    Topology
  </title>
<style type="text/css">
    #container {
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      position: absolute;
      z-index:-1;
    }

</style>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<div id="container"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
<script src="../src/sigma.min.js"></script>
<script src="../src/plugins/sigma.parsers.json.min.js"></script>
<script src="../src/plugins/sigma.plugins.dragNodes.min.js"></script>
<script src="../src/plugins/sigma.renderers.edgeLabels.min.js"></script>
<script>
  $(document).ready(function(){
    var old=myItems["items"].filter(function(e){
      return e.new=="false";
    })
    
    
    if(old.length==0)
      $('#oldElements').hide();   
  
    $('#oldElements').bind('click',function(e){
      var table=$('<table class="table">');
      
      var thead=$('<thead>');
      
      thead.append('<tr><th scope="col">Name</th><th scope="col">Ip</th><th scope="col">Mac</th></tr>');
      table.append(thead);
      var tbody=$('<tbody>')
      
      old.forEach(function(e){
           tbody.append('<tr><td>'+e.label+'</td><td>'+e.id+'</td><td>'+e.mac+'</td></tr>');
      });
      
      table.append(tbody);
      
      Swal.fire({
        html: table,
        title: 'Elements not found in new scan',
        confirmButtonText: 'OK',
        width: '60%'
      });
    });
  
  });
  var myItems;
  
  var s=sigma.parsers.json('data.json', {
    renderer: {              
        container: 'container',
        type: 'canvas'
    },
    settings: {
      defaultNodeColor: '#ec5148',
      edgeLabelSize: 'proportional'
    } },
    function(s) {      
      
       //var myItems;

      $.ajax({
        url: "diff.json",
        async: false,
        cache: false,
        dataType: "text",
        success: function( data, textStatus, jqXHR ) {
          myItems=JSON.parse(data);
        }
      });
      
      
      
      
      function click(e){
        var l=s.graph.edges().filter(function(edge){
          
          if(edge.source==e.data.node.id){
              edge.isSource=true;
              return true
          }else if(edge.target==e.data.node.id){
              edge.isSource=false;
              return true;
          }return  false;
        });
        
        
        var res='IP='+e.data.node.id+'<br>MAC='+e.data.node.mac+'<br><br><table class="table"><thead><tr><th scope="col">Name</th><th scope="col">IP</th><th scope="col">MAC</th><th scope="col">From</th><th scope="col">To</th></tr></thead><tbody>';
        
        l.forEach(function(f){
          res+='<tr>';
          if(f.isSource){
            var target=s.graph.nodes().filter(function(node){
                return node.id==f.target;
            });
            res+='<td>'+target[0].label+'</td><td>'+f.target+'</td><td>'+target[0].mac+'</td>';
          }else{
            var source=s.graph.nodes().filter(function(node){
                return node.id==f.source;
            });
            
            res+='<td>'+source[0].label+'</td><td>'+f.source+'</td><td>'+source[0].mac+'</td>';
          }
          res+='<td>'+f.from+'</td><td>'+f.to+'</td></tr>';     
        })
          
        res+='</tbody></table>'
        Swal.fire({
          html: res,
          title: 'links detail for '+e.data.node.label,
          confirmButtonText: 'OK',
          width: '60%'
        })
      }      
      
      
      
      s.bind('clickNode',click);
      
      s.graph.nodes().forEach(function(node, i, a) {
        
        myItems["items"].forEach(function(e){
          if(node.id==e.id && e.new=="true"){
            node.color="#0F0"
          }
        });
        node.x = Math.cos(Math.PI * 2 * i / a.length);
        node.y = Math.sin(Math.PI * 2 * i / a.length);
      });
      var dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);
            
      dragListener.bind('drag',function(){
         setTimeout(function () {
             s.unbind('clickNode');
         });
       });
           
      dragListener.bind('dragend',function(){
        setTimeout(function(){
          s.bind('clickNode', click);
        },250)
      });
      
      s.refresh();            
  });
  
  
</script>
<div class="float-right m-3"><input id="oldElements" class="btn btn-primary" type="button" value="Elements not found on new scan"></div>
</body>
</html>
